// Prisma Schema para AlbiEmprego
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserType {
  CANDIDATO
  EMPRESA
  ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
}

enum JobType {
  FULL_TIME
  PART_TIME
  TEMPORARY
  INTERNSHIP
  FREELANCE
}

enum WorkMode {
  PRESENCIAL
  REMOTO
  HIBRIDO
}

enum JobStatus {
  DRAFT
  PENDING
  ACTIVE
  PAUSED
  CLOSED
  REJECTED
}

enum ApplicationStatus {
  NEW
  VIEWED
  IN_REVIEW
  INTERVIEW
  REJECTED
  ACCEPTED
}

enum LanguageLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
  NATIVE
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ANNOUNCEMENT
  PROMOTION
  SYSTEM
  MAINTENANCE
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
}

// Subscription & Credits Enums
enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum CreditType {
  FEATURED    // Destaque na listagem
  HOMEPAGE    // Destaque na homepage
  URGENT      // Badge urgente
}

enum CreditDuration {
  DAYS_7      // Padrão
  DAYS_14     // Premium
  DAYS_30     // Extended
}

enum TransactionType {
  SUBSCRIPTION_PURCHASE
  SUBSCRIPTION_RENEWAL
  CREDIT_PURCHASE
  ADMIN_CREDIT_GRANT
  ADMIN_SUBSCRIPTION_GRANT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RequestType {
  PLAN_SUBSCRIPTION
  CREDIT_PURCHASE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// MODELS
// ============================================

model User {
  id       String     @id @default(uuid())
  email    String     @unique
  password String
  name     String
  phone    String?
  location String?
  avatar   String?
  bio      String?
  type     UserType
  status   UserStatus @default(PENDING)

  // Tokens de segurança
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?
  emailVerificationToken   String?   @unique
  emailVerified            Boolean   @default(false)
  emailVerificationExpires DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relações
  candidate Candidate?
  company   Company?

  @@index([email])
  @@index([type, status])
  @@map("users")
}

model Candidate {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cvUrl               String?
  skills              String[]
  experienceYears     Int?
  currentPosition     String?
  profileCompleteness Int      @default(0)

  // Relações
  experiences  Experience[]
  educations   Education[]
  languages    Language[]
  applications Application[]
  savedJobs    SavedJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("candidates")
}

model Company {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  nif         String  @unique
  website     String?
  sector      String?
  employees   String?
  description String?
  logo        String?

  // Aprovação
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  // Controle de vagas (planos)
  activeJobsCount Int @default(0)  // Contador de vagas ativas
  maxActiveJobs   Int @default(5)  // Limite do plano atual

  // Relações
  jobs Job[]
  subscriptions   CompanySubscription[]
  creditBalances  CreditBalance[]
  transactions    Transaction[]
  notifications   CompanyNotification[]
  planRequests    PlanRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([nif])
  @@map("companies")
}

model Experience {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  company     String
  position    String
  startDate   DateTime
  endDate     DateTime?
  current     Boolean   @default(false)
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([candidateId])
  @@map("experiences")
}

model Education {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  institution String
  degree      String
  field       String
  startDate   DateTime
  endDate     DateTime?
  current     Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([candidateId])
  @@map("educations")
}

model Language {
  id          String        @id @default(uuid())
  candidateId String
  candidate   Candidate     @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  language String
  level    LanguageLevel

  @@unique([candidateId, language])
  @@map("languages")
}

model Job {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  title            String
  department       String?
  description      String
  requirements     String[]
  responsibilities String[]
  benefits         String[]
  skills           String[] // Competências requeridas

  location String
  address  String? // Morada específica (opcional)
  type     JobType
  workMode WorkMode

  // Salário (opcional)
  salaryMin      Decimal? @db.Decimal(10, 2)
  salaryMax      Decimal? @db.Decimal(10, 2)
  salaryCurrency String   @default("EUR")
  salaryPeriod   String   @default("month") // "hour", "month", "year"
  showSalary     Boolean  @default(false)

  sector          String
  experienceLevel String?

  status JobStatus @default(DRAFT)

  applicationDeadline DateTime?

  // Métricas
  viewsCount   Int @default(0)
  reportsCount Int @default(0) // Contador de denúncias

  // Aprovação
  approvedAt      DateTime?
  publishedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  // Campos de destaque e urgência
  isFeatured Boolean @default(false) // Vaga em destaque (paga)
  isUrgent   Boolean @default(false) // Vaga urgente
  quickApply Boolean @default(false) // Candidatura rápida sem CV

  // Relações
  applications Application[]
  savedBy      SavedJob[]
  creditUsages CreditUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status, publishedAt])
  @@index([location, status])
  @@index([isFeatured, publishedAt])
  @@index([location, status, isFeatured])
  @@map("jobs")
}

model Application {
  id          String    @id @default(uuid())
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  coverLetter String?
  status      ApplicationStatus @default(NEW)

  // Timeline de estados (JSON array)
  timeline Json // Array de { status, date, note }

  // Notas internas (empresa)
  notes String?

  appliedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, candidateId])
  @@index([candidateId, status])
  @@index([jobId, status])
  @@map("applications")
}

model SavedJob {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  savedAt DateTime @default(now())

  @@unique([candidateId, jobId])
  @@index([candidateId])
  @@index([jobId])
  @@map("saved_jobs")
}

model Notification {
  id     String           @id @default(uuid())
  userId String
  type   NotificationType
  title  String
  message String
  read    Boolean @default(false)

  actionUrl   String?
  actionLabel String?

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@map("notifications")
}

model Conversation {
  id           String   @id @default(uuid())
  participants String[] // Array de user IDs

  // Contexto opcional
  contextType  String? // "application", "job", "support"
  contextId    String?
  contextTitle String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@map("conversations")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  content  String

  attachments Json? // Array de attachments

  status MessageStatus @default(SENT)

  isSystem   Boolean @default(false)
  systemType String?

  sentAt DateTime  @default(now())
  readAt DateTime?

  @@index([conversationId])
  @@map("messages")
}

model MaintenanceMode {
  id               String    @id @default(uuid())
  enabled          Boolean   @default(false)
  message          String?
  estimatedEndTime String?   // Texto livre: "hoje", "amanhã", "14:00", etc
  updatedAt        DateTime  @updatedAt

  @@map("maintenance_mode")
}

// ============================================
// SUBSCRIPTION & CREDITS MODELS
// ============================================

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  
  // Limites
  maxJobs     Int      @default(5) // -1 = ilimitado
  
  // Créditos mensais incluídos
  featuredCreditsMonthly  Int @default(0)
  homepageCreditsMonthly  Int @default(0)
  urgentCreditsMonthly    Int @default(0)
  
  // Duração padrão dos créditos do plano
  creditDuration CreditDuration @default(DAYS_7)
  
  // Features (JSON array)
  features    Json
  
  // Configuração
  isActive    Boolean  @default(true)
  isPopular   Boolean  @default(false)
  displayOrder Int     @default(0)
  
  // Stripe
  stripePriceId String? @unique
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  subscriptions CompanySubscription[]
  planRequests  PlanRequest[]
  
  @@map("subscription_plans")
}

model CreditPackage {
  id          String     @id @default(uuid())
  name        String
  description String
  price       Decimal    @db.Decimal(10, 2)
  currency    String     @default("EUR")
  
  // Créditos fornecidos
  featuredCredits Int @default(0)
  homepageCredits Int @default(0)
  urgentCredits   Int @default(0)
  
  // Duração dos créditos deste pacote
  creditDuration CreditDuration @default(DAYS_7)
  
  // Configuração
  isActive    Boolean @default(true)
  displayOrder Int    @default(0)
  
  stripePriceId String? @unique
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  transactions Transaction[]
  planRequests PlanRequest[]
  
  @@map("credit_packages")
}

model CompanySubscription {
  id         String             @id @default(uuid())
  companyId  String
  company    Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  planId     String
  plan       SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  status     SubscriptionStatus @default(ACTIVE)
  
  startDate  DateTime
  endDate    DateTime
  
  cancelledAt DateTime?
  cancelReason String?
  
  stripeSubscriptionId String? @unique
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([companyId, status])
  @@index([endDate])
  @@map("company_subscriptions")
}

model CreditBalance {
  id         String     @id @default(uuid())
  companyId  String
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  creditType CreditType
  amount     Int        @default(0)
  
  // Rastreamento origem
  source     String     // "PLAN_MONTHLY", "PURCHASE", "ADMIN_GRANT"
  sourceId   String?
  
  // Duração e expiração
  duration   CreditDuration @default(DAYS_7)
  expiresAt  DateTime?  // NULL para créditos do plano
  
  // Controle de notificações
  lowCreditNotified Boolean @default(false)
  expiryNotified    Boolean @default(false)
  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  usages     CreditUsage[]
  
  @@unique([companyId, creditType, source, sourceId])
  @@index([companyId, creditType])
  @@index([expiresAt])
  @@map("credit_balances")
}

model CreditUsage {
  id         String     @id @default(uuid())
  companyId  String
  jobId      String
  job        Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  balanceId  String     // Rastrear origem do crédito
  balance    CreditBalance @relation(fields: [balanceId], references: [id])
  
  creditType CreditType
  duration   CreditDuration
  
  // Período de ativação
  startDate  DateTime
  endDate    DateTime
  
  isActive   Boolean    @default(true)
  
  // Analytics ROI
  views      Int        @default(0)
  clicks     Int        @default(0)
  applications Int      @default(0)
  
  createdAt  DateTime   @default(now())
  
  @@index([jobId, creditType, isActive])
  @@index([endDate])
  @@index([balanceId])
  @@map("credit_usages")
}

model Transaction {
  id          String            @id @default(uuid())
  companyId   String
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  
  amount      Decimal           @db.Decimal(10, 2)
  currency    String            @default("EUR")
  description String
  
  planId      String?
  packageId   String?
  package     CreditPackage?    @relation(fields: [packageId], references: [id])
  
  adminId     String?
  adminNotes  String?
  
  stripePaymentIntentId String? @unique
  stripeInvoiceId       String?
  
  metadata    Json?
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([companyId, status])
  @@index([createdAt])
  @@map("transactions")
}

model CompanyNotification {
  id         String               @id @default(uuid())
  companyId  String
  company    Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  type       String               // "CREDIT_LOW", "CREDIT_EXPIRING", "RENEWAL_UPCOMING", "LIMIT_REACHED"
  priority   NotificationPriority @default(NORMAL)
  
  title      String
  message    String
  
  // Contexto
  creditType CreditType?
  jobId      String?
  
  read       Boolean   @default(false)
  readAt     DateTime?
  
  createdAt  DateTime  @default(now())
  
  @@index([companyId, read])
  @@index([createdAt])
  @@map("company_notifications")
}

model PlanRequest {
  id          String        @id @default(uuid())
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  type        RequestType
  status      RequestStatus @default(PENDING)
  
  // Para solicitações de plano
  planId      String?
  plan        SubscriptionPlan? @relation(fields: [planId], references: [id])
  
  // Para solicitações de crédito
  packageId   String?
  package     CreditPackage? @relation(fields: [packageId], references: [id])
  
  // Mensagem da empresa
  message     String?
  
  // Resposta do admin
  reviewedBy  String?
  reviewedAt  DateTime?
  adminNotes  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId, status])
  @@index([status, createdAt])
  @@map("plan_requests")
}
